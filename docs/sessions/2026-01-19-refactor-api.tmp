# Session: RLS Policy Refactor for Multi-Tenant Isolation
**Date:** 2026-01-19
**Started:** 10:00
**Last Updated:** 13:30
**Branch:** refactor/rls-policies-standardize

---

## Current State

Standardizing RLS (Row Level Security) policies across all Supabase tables. Found inconsistencies causing data leakage between tenants in some edge cases.

### Completed
- [x] Audited all existing RLS policies
- [x] Created standardized policy patterns
- [x] Fixed tickets table RLS (was leaking to other orgs)
- [x] Fixed invoices table RLS
- [x] Regenerated Supabase types

### Key Findings
- 12 tables without RLS enabled
- 5 tables with RLS enabled but no policies (blocks all access)
- 3 tables with policies using wrong column (user_id instead of organization_id)
- Partner -> Client visibility not properly implemented

### The Problem
```sql
-- BAD: This policy allows users to see ANY ticket they created
-- even if they moved to a different organization
CREATE POLICY "Users can view own tickets"
  ON tickets FOR SELECT
  USING (created_by = auth.uid());

-- GOOD: This policy checks organization membership
CREATE POLICY "Users can view org tickets"
  ON tickets FOR SELECT
  USING (
    organization_id IN (
      SELECT organization_id FROM profiles
      WHERE id = auth.uid()
    )
  );
```

### Standardized RLS Pattern

```sql
-- supabase/migrations/20260119000000_standardize_rls.sql

-- ============================================
-- STANDARD RLS POLICIES FOR MULTI-TENANT TABLES
-- ============================================

-- Helper function to get current user's organization
CREATE OR REPLACE FUNCTION auth.user_org_id()
RETURNS UUID AS $$
  SELECT organization_id FROM public.profiles WHERE id = auth.uid()
$$ LANGUAGE SQL SECURITY DEFINER;

-- Helper function to get organizations user can access (including client orgs for partners)
CREATE OR REPLACE FUNCTION auth.accessible_org_ids()
RETURNS SETOF UUID AS $$
  -- User's own organization
  SELECT organization_id FROM public.profiles WHERE id = auth.uid()
  UNION
  -- Client organizations (for partners)
  SELECT id FROM public.organizations
  WHERE parent_org_id = (SELECT organization_id FROM public.profiles WHERE id = auth.uid())
$$ LANGUAGE SQL SECURITY DEFINER;

-- ============================================
-- TICKETS TABLE
-- ============================================
ALTER TABLE tickets ENABLE ROW LEVEL SECURITY;

-- Drop old policies
DROP POLICY IF EXISTS "Users can view own tickets" ON tickets;

-- New standardized policies
CREATE POLICY "Users can view accessible tickets"
  ON tickets FOR SELECT
  USING (organization_id IN (SELECT auth.accessible_org_ids()));

CREATE POLICY "Users can create tickets in own org"
  ON tickets FOR INSERT
  WITH CHECK (organization_id = auth.user_org_id());

CREATE POLICY "Users can update own org tickets"
  ON tickets FOR UPDATE
  USING (organization_id = auth.user_org_id());

-- Staff can update any accessible ticket
CREATE POLICY "Staff can update accessible tickets"
  ON tickets FOR UPDATE
  USING (
    organization_id IN (SELECT auth.accessible_org_ids())
    AND EXISTS (
      SELECT 1 FROM profiles
      WHERE id = auth.uid()
      AND role IN ('super_admin', 'staff')
    )
  );

-- ============================================
-- INVOICES TABLE
-- ============================================
ALTER TABLE invoices ENABLE ROW LEVEL SECURITY;

CREATE POLICY "Users can view accessible invoices"
  ON invoices FOR SELECT
  USING (
    organization_id IN (SELECT auth.accessible_org_ids())
    OR client_org_id = auth.user_org_id()
  );

CREATE POLICY "Staff can create invoices"
  ON invoices FOR INSERT
  WITH CHECK (
    EXISTS (
      SELECT 1 FROM profiles
      WHERE id = auth.uid()
      AND role IN ('super_admin', 'staff', 'partner')
    )
  );
```

### Testing RLS Policies
```typescript
// tests/rls/tickets.test.ts
import { createClient } from '@supabase/supabase-js'

describe('Tickets RLS', () => {
  it('user cannot see tickets from other organizations', async () => {
    // Create client as user from org A
    const userAClient = createClient(URL, ANON_KEY, {
      global: { headers: { Authorization: `Bearer ${userAToken}` } }
    })

    // Try to fetch ticket from org B
    const { data, error } = await userAClient
      .from('tickets')
      .select('*')
      .eq('id', ticketFromOrgB.id)
      .single()

    expect(data).toBeNull()
    // RLS should filter it out, not throw an error
  })

  it('partner can see client organization tickets', async () => {
    const partnerClient = createClient(URL, ANON_KEY, {
      global: { headers: { Authorization: `Bearer ${partnerToken}` } }
    })

    const { data } = await partnerClient
      .from('tickets')
      .select('*')
      .eq('organization_id', clientOrgId)

    expect(data).not.toBeNull()
    expect(data.length).toBeGreaterThan(0)
  })
})
```

### Notes for Next Session
- Apply same pattern to remaining tables: contracts, messages, files
- Add RLS for the new chat_sessions table
- Create migration to backfill any orphaned records
- Add CI check to ensure all tables have RLS enabled

### Context to Load
```
supabase/migrations/20260119000000_standardize_rls.sql
src/lib/supabase/server.ts
tests/rls/
```

### Related KT-Portal Considerations
- Super Admin should bypass RLS (use service role key)
- Partner Staff role needs limited access within partner org
- Audit log should track cross-tenant access attempts
